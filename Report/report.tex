\documentclass[conference]{IEEEtran}
\IEEEoverridecommandlockouts
% The preceding line is only needed to identify funding in the first footnote. If that is unneeded, please comment it out.
\usepackage{cite}
\usepackage[dvipsnames]{xcolor}
\usepackage{varwidth}
\usepackage{amsmath,amssymb,amsfonts}
\usepackage{algorithmic}
\usepackage{graphicx}
\usepackage{textcomp}
\usepackage{bm}
\usepackage{bbm}
\usepackage{empheq}
\usepackage{etoolbox}
\usepackage{hyperref}



\def\BibTeX{{\rm B\kern-.05em{\sc i\kern-.025em b}\kern-.08em
    T\kern-.1667em\lower.7ex\hbox{E}\kern-.125emX}}
    
    
\DeclareMathOperator*{\argmin}{arg\,min}
\DeclareMathOperator*{\grad}{grad}
\let\div\undefined
\DeclareMathOperator*{\div}{div}

\newcommand*{\E}[1]{\ensuremath{\mathbb{E}\left[#1\right]}}
\renewcommand*{\P}[2][]{\ensuremath{\mathbb{P}#1\left(#2\right)}}
\newcommand*{\Var}[1]{\ensuremath{\text{Var}\left(#1\right)}}
\newcommand*{\Cov}[2]{\ensuremath{\text{Cov}\left({#1}, {#2}\right)}}
\newcommand*{\Corr}[1]{\ensuremath{\text{Corr}\left(#1\right)}}
\newcommand*{\sd}[1]{\ensuremath{\sigma_{#1}}}
\newcommand*{\card}[1]{\ensuremath{\lvert#1\rvert}}
\newcommand*{\warn}[1]{\textcolor{OrangeRed}{#1}}
\newcommand*{\important}[1]{\fcolorbox{BurntOrange}{BurntOrange!10!White}{\begin{varwidth}{\textwidth}
#1
\end{varwidth}}}
\renewcommand*{\d}[1]{\ensuremath{\mathrm{d}#1}}
\newcommand*{\dist}{\sim}
\newcommand*{\indicator}{\ensuremath{\mathbb{1}}}
\newcommand*{\reals}{\ensuremath{\mathbb{R}}}
\newcommand*{\integers}{\ensuremath{\mathbb{Z}}}
\newcommand*{\naturals}{\ensuremath{\mathbb{N}}}
\newcommand*{\abs}[1]{\ensuremath{\left\lvert#1\right\rvert}}
\newcommand*{\floor}[1]{\ensuremath{\lfloor#1\rfloor}}
\newcommand*{\inclimg}[2][]{\begin{figure}[H]\centering\includegraphics[max width=0.9\textwidth,keepaspectratio]{#2}#1\end{figure}}
\newcommand*{\diff}[2]{\ensuremath{\frac{\d}{\d{#2}}{#1}}}
\newcommand*{\pdiff}[2]{\ensuremath{\frac{\partial}{\partial{#2}}{#1}}}
\newcommand*{\ddiff}[2]{\ensuremath{\frac{\delta}{\delta{#2}}{#1}}}
\newcommand*{\mdiff}[3]{\ensuremath{\frac{\d{^{#3}}}{\d{#2}^{#3}}{#1}}}
\newcommand*{\pmdiff}[3]{\ensuremath{\frac{\partial{^{#3}}}{\partial{#2}^{#3}}{#1}}}

\newcommand*{\at}[1]{\ensuremath{\biggr\rvert_{#1}}}
\renewcommand*{\i}{\ensuremath{\text{i}}}
\newcommand{\distlike}{\ensuremath{\sim}}
\newcommand{\normaldist}[2]{\ensuremath{\mathcal{N}\left(#1, #2\right)}}
\newcommand{\asnormaldist}[2]{\distlike\normaldist{#1}{#2}}
\renewcommand*{\vec}[1]{\ensuremath{{\bm{#1}}}}
\newcommand*{\mat}[1]{\vec{#1}}
\newcommand*{\transpose}[1]{{#1}^{\mkern-1.5mu\mathsf{T}}}
\newcommand*{\invert}[1]{{#1}^{-1}}
\newcommand*{\tvec}[1]{\transpose{\vec{#1}}}
\newcommand*{\tmat}[1]{\tvec{#1}}
\newcommand*{\rgramian}[1]{{#1}\transpose{#1}}
\newcommand*{\lgramian}[1]{\transpose{#1}{#1}}
\renewcommand*{\indicator}{\ensuremath{\mathbbm{1}}}
\newcommand*{\invmat}[1]{\ensuremath{\invert{\mat{#1}}}}
\newcommand*{\iprod}[3]{\ensuremath{\ifstrempty{#1}{\transpose{#2} {#3}}{\transpose{#1} {#2} {#3}}}}
\newcommand*{\ciprod}[2]{\ensuremath{\left\langle{#1},{#2}\right\rangle}}
\newcommand*{\miprod}[2]{\iprod{#1}{#2}{#1}}
\newcommand*{\enm}[1]{\left\langle{#1}\right\rangle}
\DeclareMathOperator*{\hmean}{hmean}
%\newcommand*{\grad}{\mathrm{grad}}
%\renewcommand*{\div}{\mathrm{div}}
\newcommand*{\bigO}[1]{\ensuremath{\mathcal{O}\left({#1}\right)}}
\begin{document}

\title{Report for the semester thesis ``Development of a Monte Carlo algorithm for optimal control problems''}

\author{\IEEEauthorblockN{Stefano Weidmann}
\IEEEauthorblockA{\textit{Institute of fluid dynamics} \\
\textit{ETH Zurich}\\
Zurich, Switzerland \\
\href{mailto:stefanow@student.ethz.ch}{stefanow@student.ethz.ch}}}
%\and
%\IEEEauthorblockN{2\textsuperscript{nd} Given Name Surname}
%\IEEEauthorblockA{\textit{dept. name of organization (of Aff.)} \\
%\textit{name of organization (of Aff.)}\\
%City, Country \\
%email address}
%\and
%\IEEEauthorblockN{3\textsuperscript{rd} Given Name Surname}
%\IEEEauthorblockA{\textit{dept. name of organization (of Aff.)} \\
%\textit{name of organization (of Aff.)}\\
%City, Country \\
%email address}
%\and
%\IEEEauthorblockN{4\textsuperscript{th} Given Name Surname}
%\IEEEauthorblockA{\textit{dept. name of organization (of Aff.)} \\
%\textit{name of organization (of Aff.)}\\
%City, Country \\
%email address}
%\and
%\IEEEauthorblockN{5\textsuperscript{th} Given Name Surname}
%\IEEEauthorblockA{\textit{dept. name of organization (of Aff.)} \\
%\textit{name of organization (of Aff.)}\\
%City, Country \\
%email address}
%\and
%\IEEEauthorblockN{6\textsuperscript{th} Given Name Surname}
%\IEEEauthorblockA{\textit{dept. name of organization (of Aff.)} \\
%\textit{name of organization (of Aff.)}\\
%City, Country \\
%email address}
%}

\maketitle

\begin{abstract}
TODO *CRITICAL: Do Not Use Symbols, Special Characters, Footnotes, 
or Math in Paper Title or Abstract.
\end{abstract}

\begin{IEEEkeywords}
a, b, c
\end{IEEEkeywords}

\section{Problem description}
The problem we want to solve is a variant of the \emph{quarter five spot problem} in literature.
We model a cross section of an oil field as a two dimensional square $\Omega := [0, 1]^2.$ In the oilfield, there are two phases: water and oil. 
At the lower left corner $\vec{x}_\text{drill} := (0, 0)$, we know the pressure $p_\text{drill}(t)$ . Opposite of that, at $\vec{x}_\text{well} := (1, 1)$ a well is located.
There we can measure the pressure $p_\text{well}(t)$ as well as the total volumetric outflow \[{Q}_\text{tot}(t) := {Q}_\text{o}(t) + {Q}_\text{w}(t)\] per unit depth.

The flow rates for both phases are described by Darcy's law
\begin{equation}
\label{flowrateWater}
\vec{v}_\text{w} = -\frac{k k_\text{rel, w}}{\mu_\text{w}} \grad(p),
\end{equation}
for water and
\begin{equation}
\label{flowrateOil}
\vec{v}_\text{o} = -\frac{k k_\text{rel, o}}{\mu_\text{o}} \grad(p)
\end{equation}
for oil.
Here, $p(\vec{x}, t)$ is the pressure, $\mu_\text{o}$, $\mu_\text{w}$ are dynamic viscosities for oil and water, $k(\vec{x}, t)$ is the permeability.
$k_\text{rel, o}(S)$, $k_\text{rel, w}(S)$ are relative permeabilities and are assumed to depend quadratically on the saturation of water $S_\text{w} \in [0, 1]$ and the saturation of oil $S_\text{o} \in [0, 1]$:
\begin{align}
\label{relativePermeabilityModel}
k_\text{rel, o} &= S_\text{o}^2\\
k_\text{rel, w} &= S_\text{w}^2.
\end{align}
The saturations are linked by the constitutive relation
\begin{equation}
S_\text{o} + S_\text{w} = 1.
\end{equation}

$\vec{v}_\text{o}(\vec{x}, t)$, $\vec{v}_\text{w}(\vec{x}, t)$ finally are the volumetric flow rates per unit area (Darcy velocities).

The saturation $S$ is not assumed constant but instead is transported according to the equation
\begin{equation}
\label{stransp}
\phi\pdiff{S_\text{w}}{t} + \div(\vec{v}_\text{w}) = q_\text{w}.
\end{equation}
The term
\begin{equation}
q_\text{w} := Q_\text{w}\delta(\vec{x} - \begin{pmatrix}1\\1\end{pmatrix})
\end{equation}
describes a line sink of water located at the well.
Similarly, we use
\begin{align}
q_\text{o} &:= Q_\text{o}\delta(\vec{x} - \begin{pmatrix}1\\1\end{pmatrix}) \\
q_\text{tot} &:= q_\text{o} + q_\text{w}.
\end{align}
$\phi$ is the porosity of the rock which is assumed to be constant over the domain.

Conservation of the total mass then reads
\begin{equation}
\label{conservationOfMass}
\div(\vec{v}_\text{tot}) = q_\text{tot},
\end{equation}
where
\begin{equation}
\vec{v}_\text{tot} := \vec{v}_\text{o} + \vec{v}_\text{w}
\end{equation}
is the total Darcy velocity.

We then introduce the mobilities
\begin{align}
\label{lambdas}
\lambda_\text{o} &:= \frac{k k_\text{rel, o}}{\mu_\text{o}} \\
\lambda_\text{w} &:= \frac{k k_\text{rel, w}}{\mu_\text{w}} \\
\lambda_\text{tot} &:= \lambda_\text{o} + \lambda_\text{w}.
\end{align}

Substituting in the $\lambda$ from \eqref{lambdas} into Darcy's law \eqref{flowrateOil}, \eqref{flowrateWater} and adding both sides of the results we get the total Darcy's law

\begin{equation}
\label{flowrateTotal}
\vec{v}_\text{tot} = - \lambda_\text{tot} \grad(p).
\end{equation}

Plugging this \eqref{flowrateTotal} into the conservation of mass \eqref{conservationOfMass} leads to the pressure equation
\begin{empheq}[box=\fbox]{equation}
\label{pressurePoisson}
\div(\lambda_\text{tot}\grad(p)) = -q_\text{tot}.
\end{empheq}

Comparing the total Darcy's law \eqref{flowrateTotal} and the Darcy's law for water \eqref{flowrateWater}, we see that
\begin{equation}
\vec{v}_\text{w} = \frac{\lambda_\text{w}}{\lambda_\text{tot}} \vec{v}_\text{tot}.
\end{equation}

We then plug in the model for the relative permeabilities in terms of the saturations \eqref{relativePermeabilityModel}, to get the final for of saturation transport equation

\begin{empheq}[box=\fbox]{equation}
\label{saturationEquation}
\pdiff{S_\text{w}}{t} + \div\left(f(S_\text{w}) \vec{v}_\text{tot})\right) = \frac{q_\text{w}}{\phi},
\end{empheq}
where $f$ is the flux function
\begin{empheq}[box=\fbox]{equation}
f(S_\text{w}) := \frac{S_\text{w}^2 / \phi}{S_\text{w}^2 + (1-S_\text{w})^2 \mu_\text{w} / \mu_\text{o}}.
\end{empheq}

\subsection{Boundary and initial conditions}
We assume the initial saturation of water to be given,
which is $S_\text{w}(\vec{x}, 0).$
For the pressure equation we use homogeneous Neumann boundary conditions (no flow), i.e.
\begin{equation}
\grad(p) = p_0 \begin{pmatrix} \delta(x - x_w) \\ \delta(y - y_w), \end{pmatrix},
\end{equation}
where we choose $p_0$ such that the compatibility condition
\begin{equation}
\int_\Omega q_\text{tot} \d{A} \overset{!}{=} \int_{\partial\Omega} \lambda_\text{tot} \iprod{}{\grad(p)}{\vec{n}} \d{l}
\end{equation}
is satisfied.

\subsection{What to optimize?}
To test the Monte-Carlo adjoint method, we want to match the pressure difference between drill and well, which is 
\begin{equation}
\label{costFunction}
c(T) := \int_0^T \biggr(\big(p_\text{drill}(t) - p_\text{well}(t)\big) - \big(\tilde{p}_\text{drill}(t) - \tilde{p}_\text{well}(t)\big)\biggr)^2 \d{t},
\end{equation}
where the variables with a tilde denote computed quantities and $T$ is a final time.

\section{Discretization}
We discretize the square domain $\Omega$ with $n \times n$ square finite volumes, thus getting a mesh width of $h := 1/n$.

An overview of the discretization technique is given in the following procedure:
\begin{enumerate}
	\item Solve the pressure equation \eqref{pressurePoisson} as detailed in subsection \ref{discPressurePoisson}
	\item Compute the total Darcy velocity as in \eqref{flowrateTotal}, using the same approximation of the gradient as in the first step
	\item Consider the total Darcy velocity to be independent of the saturation $S_\text{w}.$
	\item With this assumption, solve the saturation equation \eqref{saturationEquation} as in subsection \ref{discSaturationEquation}
	\item Update the relative permeabilities according to \eqref{relativePermeabilityModel} and repeat.
\end{enumerate}

\subsection{Discretizing the pressure Poisson equation}
\label{discPressurePoisson}
Averaging the pressure Poisson equation \eqref{pressurePoisson} over such a finite volume $K$, and using the divergence theorem leads to
\begin{equation}
\label{finiteVolumes}
\frac{1}{h^2} \int_{\partial K} \lambda_\text{tot} \iprod{}{\grad(p)}{\vec{n}} \d{l} = -\frac{1}{h^2} \int_K q_\text{tot} \d{A}.
\end{equation}
Using the four boundaries $N$orth, $E$ast, $S$outh and $W$est of the finite volume $K$, we approximate \eqref{finiteVolumes} as
\begin{multline}
\frac{1}{h}\biggr( (\lambda_\text{tot} \ddiff{p}{x})\lvert_\text{E} - (\lambda_\text{tot} \ddiff{p}{x})\lvert_\text{W} \\+ (\lambda_\text{tot}\ddiff{p}{y})\lvert_\text{N}
- \ddiff{p}{y})\lvert_\text{S} \biggr) \\= - \frac{Q_\text{tot}}{h^2} \cdot \begin{cases} 1, &\text{if } K \text{ is the finite volume nearest to the well} \\
0, & \text{otherwise} \end{cases}
\end{multline}

$\ddiff{\cdot}{\cdot}$ denote the standard finite difference quotients, i.e.
\begin{align}
\label{differenceQuotients}
\ddiff{p}{x}\lvert_\text{E} &= \frac{1}{h}(p_R - p_K) \\
\ddiff{p}{x}\lvert_\text{W} &= \frac{1}{h}(p_K - p_D) \\
\ddiff{p}{y}\lvert_\text{N} &= \frac{1}{h}(p_U - p_K) \\
\ddiff{p}{y}\lvert_\text{S} &= \frac{1}{h}(p_K - p_D).
\end{align}
Here, $U$ stands for the upper neighbor of $K$, $D$ for the lower (down), $R$ for the right and $L$ for the left.
$p_K$ is the pressure at the center of the volume, which is taken to be the same as the volume averaged $\bar{p}$, as our scheme is just first order.

The total mobilities $\lambda_\text{tot}$ at the boundaries are approximated by the harmonic mean of the total mobilities inside the adjacent finite volumes as
\begin{align}
\label{harmonicMeans}
\lambda_\text{tot}\lvert_\text{E} &\approx \hmean(\lambda_\text{tot}\lvert_K, \lambda_\text{tot}\lvert_R) \\
\lambda_\text{tot}\lvert_\text{W} &\approx \hmean(\lambda_\text{tot}\lvert_K, \lambda_\text{tot}\lvert_L) \\
\lambda_\text{tot}\lvert_\text{N} &\approx \hmean(\lambda_\text{tot}\lvert_K, \lambda_\text{tot}\lvert_U) \\
\lambda_\text{tot}\lvert_\text{S} &\approx \hmean(\lambda_\text{tot}\lvert_K, \lambda_\text{tot}\lvert_D),
\end{align}
where \begin{equation}
\hmean(a, b) = 2ab/(a+b).
\end{equation}
\important{Explain why the harmonic mean}

The discretized pressure Poisson equation reads
\begin{multline}
T_E (p_K - p_R) + T_W (p_K - p_L) \\+ T_N ( p_K - p_U) + T_S (p_K - p_D) \\= {Q_\text{tot}} \cdot \begin{cases} 1, &\text{if } K \text{ is the finite volume nearest to the well} \\
0, & \text{otherwise} \end{cases},
\end{multline}

where \begin{equation}
T_N = \hmean(\lambda_\text{tot}\lvert_K, \lambda_\text{tot}\lvert_U),
\end{equation}
and so on.

\subsection{Discretizing the saturation equation}
\label{discSaturationEquation}
The finite volume reformulation of the saturation equation \eqref{saturationEquation} leads to the following:
\begin{multline}
\label{saturationEquationFV}
\pdiff{\frac{1}{h^2} \int_K S_\text{w} \d{A}}{t} \\+ \frac{1}{h}\biggr((f(S_\text{w})v_{\text{tot }, x})\lvert_E - (f(S_\text{w})v_{\text{tot }, x})\lvert_W \\+ (f(S_\text{w})v_{\text{tot }, y})\lvert_N - (f(S_\text{w})v_{\text{tot }, y})\lvert_S\biggr) \\=
\frac{Q_\text{w}}{h^2 \phi} \cdot \begin{cases} 1, &\text{if } K \text{ is the finite volume nearest to the well} \\0, &\text{otherwise}\end{cases}
\end{multline}

We identify the volume average
\begin{equation}
\frac{1}{h^2} \int_K S_\text{w} \d{A} =: S_K,
\end{equation}
with the saturation at the center of the volume $S_K$. This is legit, as our scheme is just first order.

For the total Darcy velocity $\vec{v}_\text{tot}$ we use the same discretization of the pressure gradients as in the pressure equation, \eqref{differenceQuotients}.
This makes it available at the boundaries ($N$, $S$, $E$, $W$), as required by \eqref{saturationEquationFV}.

For the flux function $f$ at the boundaries, we use an upwind discretization. The standard formulation can be simplified by noting that \begin{equation}
\diff{f}{S_\text{w}} > 0
\end{equation}
and so instead of the advection velocity
\begin{equation}
\pdiff{(f \cdot \vec{v}_\text{tot})}{S_\text{w}}
\end{equation}
we can use the Darcy velocity $\vec{v}_\text{tot}.$
We remember that this requires fixing the total Darcy velocity $\vec{v}_\text{tot}$ to be independent of the saturation $S_\text{w}$

For timestepping of the saturation equation \eqref{saturationEquationFV} , we use explicit Euler, as this simplifies the Jacobian used in the Monte-Carlo adjoint.

\subsection{Discretizing the cost function}
The cost function \eqref{costFunction} is discretized as a sum of squares over the timesteps, where the computed quantities with a tilde are taken to be the quantities in the volumes nearest to the well and the drill.

\begin{equation}
\sum_{i=1}^{n} (\Delta p(i\Delta t) - \tilde{\Delta p}^{(i)})^2,
\end{equation}
where
\begin{align}
\Delta_p(t) &:= p_\text{well}(t) - p_\text{drill}(t) \\
\tilde{\Delta p}^{(i)} &:= p_\text{well cell}^{(i)} - p_\text{drill cell}^{(i)}
\end{align}
and $\Delta t$ is the timestep.

\section{Computing the quantities for the Monte-Carlo adjoint solver}

First, we define the pressure residuals
\begin{multline}
\Pi_K^{(i)} := T_E^{(i-1)} (p_K^{(i)} - p_R^{(i)}) + T_W^{(i-1)} (p_K^{(i)} - p_L^{(i)}) \\+ T_N ( p_K^{(i)} - p_U^{(i)}) + T_S^{(i-1)} (p_K^{(i)} - p_D^{(i)}) - Q_\text{tot, K}^{(i-1)}, 
\end{multline}
where
\begin{equation}
Q_\text{tot, K}^{(i)} := Q_\text{tot}(i\Delta t) \cdot \begin{cases} 1, &\text{if } K \text{ is the cell nearest to the well}\\0, &\text{ otherwise} \end{cases}
\end{equation}

The saturation residuals are given by
\begin{multline}
\Sigma_K^{(i)} := S_K^{(i)} - S_K^{(i-1)} \\+ \frac{\Delta t}{h} \biggr((f(S_\text{w}^{(i-1)})v_{\text{tot }, x}^{(i-1)})\lvert_E - (f(S_\text{w}^{(i-1)})v_{\text{tot }, x}^{(i-1)})\lvert_W \\+ (f(S_\text{w}^{(i-1)})v_{\text{tot }, y}^{(i-1)})\lvert_N - (f(S_\text{w}^{(i-1)})v_{\text{tot }, y}^{(i-1)})\lvert_S\biggr) - \Delta t Q_\text{tot, K}^{(i-1)}.
\end{multline}

The nonzero derivatives for the diagonal blocks are given by
\begin{align}
\pdiff{\Pi_K^{(i)}}{p_K^{(i)}} &= T_E^{(i-1)} + T_W^{(i-1)} + T_N^{(i-1)} + T_S^{(i-1)} \\
\pdiff{\Pi_K^{(i)}}{p_R^{(i)}} &= -T_E^{(i-1)} \\
\pdiff{\Pi_K^{(i)}}{p_L^{(i)}} &= -T_W^{(i-1)} \\
\pdiff{\Pi_K^{(i)}}{p_N^{(i)}} &= -T_U^{(i-1)} \\
\pdiff{\Pi_K^{(i)}}{p_S^{(i)}} &= -T_D^{(i-1)}
\end{align}

and by
\begin{align}
\pdiff{\Sigma_K^{(i)}}{S_K^{(i)}} &= 1 \\
\pdiff{\Sigma_K^{(i)}}{{S_{\text{w}}}_K^{(i-1)}} &=  f^\prime({S_{\text{w}}}_K^{(i-1)}) \cdot \biggr(\indicator(v_\text{tot, x}\lvert_E > 0) v_\text{tot, x}\lvert_E \\&+ \indicator(v_\text{tot, x}\lvert_W < 0) v_\text{tot, x}\lvert_W + \indicator(v_\text{tot, y}\lvert_N > 0) v_\text{tot, y}\lvert_N  \nonumber\\&+ \indicator(v_\text{tot, y}\lvert_S < 0) v_\text{tot, y}\lvert_S\biggr) \nonumber\\ 
\pdiff{\Sigma_K^{(i)}}{{S_{\text{w}}}_R^{(i-1)}} &= f^\prime({S_{\text{w}}}_R^{(i-1)}) \frac{\Delta t}{h}\cdot \indicator(v_\text{tot, x}\lvert_E < 0) v_\text{tot, x}\lvert_E \\
\pdiff{\Sigma_K^{(i)}}{{S_{\text{w}}}_L^{(i-1)}} &= f^\prime({S_{\text{w}}}_L^{(i-1)}) \frac{\Delta t}{h}\cdot \indicator(v_\text{tot, x}\lvert_W > 0) v_\text{tot, x}\lvert_W \\
\pdiff{\Sigma_K^{(i)}}{{S_{\text{w}}}_U^{(i-1)}} &= f^\prime({S_{\text{w}}}_U^{(i-1)}) \frac{\Delta t}{h}\cdot \indicator(v_\text{tot, y}\lvert_N < 0) v_\text{tot, y}\lvert_N \\
\pdiff{\Sigma_K^{(i)}}{{S_{\text{w}}}_D^{(i-1)}} &= f^\prime({S_{\text{w}}}_D^{(i-1)}) \frac{\Delta t}{h}\cdot \indicator(v_\text{tot, y}\lvert_S > 0) v_\text{tot, x}\lvert_S,
\end{align}
where
\begin{align}
f^\prime(S_\text{w}) &=  \frac{2\mu_\text{o}\mu_\text{w} (1 - S_\text{w})S_\text{w}}{\phi \cdot \left(\mu_\text{w}(1 - S_\text{w})^2 + \mu_\text{o}S_\text{w}^2\right)^2}\\
\indicator(b) &= \begin{cases} 1, &\text{if } b \text{ true} \\ 0, &\text{otherwise.}
\end{cases}
\end{align}

For the off diagonal blocks, we have
\begin{align}
\pdiff{\Sigma_K^{(i)}}{p_K^{(i)}} &= \frac{\Delta t}{h^2} \biggr(T_E^{(i-1)} f(S_\text{w}^{(i-1)})\lvert_E \\&+ T_W^{(i-1)} f(S_\text{w}^{(i-1)})\lvert_W \nonumber\\&+ T_N^{(i-1)} f(S_\text{w}^{(i-1)})\lvert_N \nonumber\\&+T_S^{(i-1)}  f(S_\text{w}^{(i-1)})\lvert_S\biggr) \nonumber\\
\pdiff{\Sigma_K^{(i)}}{p_R^{(i)}} &= -\frac{\Delta t}{h^2}T_E^{(i-1)} f(S_\text{w}^{(i-1)})\lvert_E \\
\pdiff{\Sigma_K^{(i)}}{p_L^{(i)}} &= -\frac{\Delta t}{h^2}T_W^{(i-1)} f(S_\text{w}^{(i-1)})\lvert_W \\\\
\pdiff{\Sigma_K^{(i)}}{p_U^{(i)}} &= -\frac{\Delta t}{h^2}T_N^{(i-1)} f(S_\text{w}^{(i-1)})\lvert_N \\
\pdiff{\Sigma_K^{(i)}}{p_D^{(i)}} &= -\frac{\Delta t}{h^2}T_S^{(i-1)} f(S_\text{w}^{(i-1)})\lvert_S,
\end{align}
and
\begin{align}
\pdiff{\Pi_K^{(i)}}{{S_\text{w}}_K^{(i)}} &= 2 \pdiff{\lambda_\text{tot}^{(i-1)}}{S_\text{w}}\lvert_K\\&\sum_{n\in\{U, D, L, R\}} \frac{(p_K^{(i-1)} - p_n^{(i-1)}) \cdot (\lambda_{\text{tot, }n}^{(i-1)})^2}{(\lambda_{\text{tot, }K}^{(i-1)} + \lambda_{\text{tot, }n}^{(i-1)})^2} \nonumber\\
\pdiff{\Pi_K^{(i)}}{{S_\text{w}}_R^{(i)}} &= 2 \pdiff{\lambda_\text{tot}^{(i-1)}}{S_\text{w}}\lvert_R \cdot
\frac{(p_K^{(i-1)} - p_R^{(i-1)}) \cdot (\lambda_{\text{tot, }K}^{(i-1)})^2}{(\lambda_{\text{tot, }K}^{(i-1)} + \lambda_{\text{tot, }R}^{(i-1)})^2} \\
\pdiff{\Pi_K^{(i)}}{{S_\text{w}}_L^{(i)}} &= 2 \pdiff{\lambda_\text{tot}^{(i-1)}}{S_\text{w}}\lvert_L \cdot
\frac{(p_K^{(i-1)} - p_L^{(i-1)}) \cdot (\lambda_{\text{tot, }K}^{(i-1)})^2}{(\lambda_{\text{tot, }K}^{(i-1)} + \lambda_{\text{tot, }L}^{(i-1)})^2} \\
\pdiff{\Pi_K^{(i)}}{{S_\text{w}}_U^{(i)}} &= 2 \pdiff{\lambda_\text{tot}^{(i-1)}}{S_\text{w}}\lvert_U \cdot
\frac{(p_K^{(i-1)} - p_U^{(i-1)}) \cdot (\lambda_{\text{tot, }K}^{(i-1)})^2}{(\lambda_{\text{tot, }K}^{(i-1)} + \lambda_{\text{tot, }U}^{(i-1)})^2} \\
\pdiff{\Pi_K^{(i)}}{{S_\text{w}}_D^{(i)}} &= 2 \pdiff{\lambda_\text{tot}^{(i-1)}}{S_\text{w}}\lvert_D \cdot
\frac{(p_K^{(i-1)} - p_D^{(i-1)}) \cdot (\lambda_{\text{tot, }K}^{(i-1)})^2}{(\lambda_{\text{tot, }K}^{(i-1)} + \lambda_{\text{tot, }D}^{(i-1)})^2} \\
\end{align}
where
\begin{align}
\pdiff{\lambda_\text{tot}}{S_\text{w}} &= 2k\left(\frac{S_\text{w} - 1}{\mu_\text{o}} + \frac{S_\text{w}}{\mu_\text{w}}\right)
\end{align}
%\bibliographystyle{IEEEtran}
%\bibliography{references}
\end{document}
